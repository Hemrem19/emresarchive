// Prisma Schema for citavErs
// Database schema matching BACKEND_PLAN.md specifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users Table
model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  passwordHash    String    @map("password_hash")
  name            String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  emailVerified   Boolean   @default(false) @map("email_verified")
  verificationToken String?  @unique @db.VarChar(255) @map("verification_token")
  verificationTokenExpiry DateTime? @map("verification_token_expiry")
  lastLoginAt     DateTime? @map("last_login_at")
  lastSyncedAt    DateTime? @map("last_synced_at")
  storageUsedBytes BigInt   @default(0) @map("storage_used_bytes")
  storageLimitBytes BigInt  @default(2147483648) @map("storage_limit_bytes") // 2GB default
  
  // Settings (JSONB)
  settings        Json      @default("{}")
  
  // Relations
  papers          Paper[]
  collections     Collection[]
  annotations     Annotation[]
  sessions        Session[]
  syncLogs        SyncLog[]
  networkGraphs   NetworkGraph[]
  
  @@index([email])
  @@map("users")
}

// Papers Table
model Paper {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  
  // Paper metadata
  title           String    @db.VarChar(500)
  authors         String[]  @default([])
  year            Int?
  journal         String?   @db.VarChar(255)
  doi             String?
  url             String?   @db.VarChar(500)
  abstract        String?   @db.Text
  tags            String[]  @default([])
  status          String    @default("To Read") @db.VarChar(50)
  relatedPaperIds Int[]    @default([]) @map("related_paper_ids")
  
  // File reference
  pdfUrl          String?   @db.VarChar(500) @map("pdf_url")
  pdfSizeBytes    BigInt?   @map("pdf_size_bytes")
  
  // Notes (rich text HTML)
  notes           String?   @db.Text
  
  // Reading progress (JSONB)
  readingProgress Json?     @map("reading_progress")
  
  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Sync metadata
  clientId        String?   @db.VarChar(100) @map("client_id")
  version        Int       @default(1)
  deletedAt      DateTime? @map("deleted_at")
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  annotations    Annotation[]
  
  // Citation relationships
  citingPapers    PaperConnection[] @relation("CitingPapers")
  citedPapers     PaperConnection[] @relation("CitedPapers")
  @@map("papers")
}

// Collections Table
model Collection {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  
  name            String    @db.VarChar(255)
  icon            String    @default("folder") @db.VarChar(50)
  color           String    @default("text-primary") @db.VarChar(50)
  
  // Filter criteria (JSONB)
  filters         Json
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  version         Int       @default(1)
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([userId, updatedAt])
  @@map("collections")
}

// Annotations Table
model Annotation {
  id              Int       @id @default(autoincrement())
  paperId         Int       @map("paper_id")
  userId          Int       @map("user_id")
  
  // Annotation data
  type            String    @db.VarChar(50) // 'highlight', 'note', 'bookmark'
  pageNumber      Int?      @map("page_number")
  position        Json?     // {x, y, width, height} for highlights
  content         String?   @db.Text
  color           String?   @db.VarChar(50)
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  version         Int       @default(1)
  
  // Relations
  paper           Paper     @relation(fields: [paperId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([paperId])
  @@index([userId])
  @@map("annotations")
}

// Sessions Table
model Session {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  tokenHash       String    @unique @map("token_hash")
  deviceName      String?   @db.VarChar(255) @map("device_name")
  userAgent       String?   @db.Text @map("user_agent")
  ipAddress       String?   @db.VarChar(45) @map("ip_address")
  createdAt       DateTime  @default(now()) @map("created_at")
  expiresAt       DateTime  @map("expires_at")
  lastActivityAt  DateTime  @default(now()) @updatedAt @map("last_activity_at")
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// Sync Log Table (for debugging)
model SyncLog {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  entityType      String?   @db.VarChar(50) @map("entity_type") // 'paper', 'collection', 'annotation'
  entityId        Int?      @map("entity_id")
  action          String?   @db.VarChar(50) // 'create', 'update', 'delete'
  clientId        String?   @db.VarChar(100) @map("client_id")
  syncedAt        DateTime  @default(now()) @map("synced_at")
  
  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([syncedAt])
  @@map("sync_logs")
}

// Paper Network Models

model PaperConnection {
  id            String   @id @default(cuid())
  fromPaperId   Int      @map("from_paper_id")
  toPaperId     Int      @map("to_paper_id")
  connectionType String  @map("connection_type") // "cites" | "cited_by"
  source        String   // "auto" | "manual" | "suggested"
  confidence    Float?   @default(1.0) // For auto-detected (0-1)
  createdAt     DateTime @default(now()) @map("created_at")
  
  fromPaper     Paper    @relation("CitingPapers", fields: [fromPaperId], references: [id], onDelete: Cascade)
  toPaper       Paper    @relation("CitedPapers", fields: [toPaperId], references: [id], onDelete: Cascade)
  
  @@unique([fromPaperId, toPaperId, connectionType])
  @@index([fromPaperId])
  @@index([toPaperId])
  @@map("paper_connections")
}

model CitationCache {
  id            String   @id @default(cuid())
  doi           String   @unique
  apiSource     String   @map("api_source") // "semantic_scholar" | "openalex"
  citationCount Int      @default(0) @map("citation_count")
  referenceCount Int     @default(0) @map("reference_count")
  rawData       Json     @map("raw_data") // Store full API response
  lastFetched   DateTime @default(now()) @map("last_fetched")
  expiresAt     DateTime @map("expires_at") // Cache for 90 days
  
  @@index([expiresAt])
  @@map("citation_cache")
}

model NetworkGraph {
  id          String   @id @default(cuid())
  userId      Int      @map("user_id")
  name        String
  description String?
  isAuto      Boolean  @default(false) @map("is_auto") // Auto-generated vs manual
  nodeCount   Int      @default(0) @map("node_count")
  edgeCount   Int      @default(0) @map("edge_count")
  layout      Json?    // Store node positions
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("network_graphs")
}
